<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Shopping Assistant</title>

    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --bot: #334155;
            --user: #3b82f6;
            --text: #f8fafc;
            --muted: #94a3b8;
        }

        * {
            box-sizing: border-box;
            font-family: Inter, system-ui, sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 1rem 2rem;
            background: rgba(30, 41, 59, .9);
            border-bottom: 1px solid #334155;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 10;
        }

        main {
            flex: 1;
            margin-top: 64px;
            padding: 2rem;
            overflow-y: auto;
            max-width: 900px;
            width: 100%;
            margin-inline: auto;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .avatar {
            width: 32px;
        }

        .bubble {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            max-width: 75%;
            white-space: pre-wrap;
        }

        .bot .bubble {
            background: var(--bot);
        }

        .user .bubble {
            background: var(--user);
        }

        .input-container {
            padding: 1rem;
            border-top: 1px solid #334155;
            background: var(--bg);
        }

        form {
            display: flex;
            gap: 1rem;
            background: var(--panel);
            padding: 0.5rem;
            border-radius: 0.75rem;
        }

        input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            outline: none;
            padding: 0.5rem;
        }

        button {
            background: #3b82f6;
            border: none;
            color: white;
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
        }

        button:disabled {
            background: #475569;
            cursor: not-allowed;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .product-card {
            background: var(--panel);
            border-radius: 0.75rem;
            text-decoration: none;
            color: var(--text);
            padding: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .product-image {
            width: 100%;
            height: 150px;
            object-fit: contain;
            background: #020617;
            border-radius: 0.5rem;
        }

        .product-title {
            font-size: 0.9rem;
            line-height: 1.2;
        }

        .product-price {
            font-weight: 700;
            color: #4ade80;
        }
    </style>
</head>

<body>
    <header>
        <h1>üõçÔ∏è AI Shopping Assistant</h1>
    </header>

    <main id="chat"></main>

    <div class="input-container">
        <form id="form">
            <input id="input" placeholder="What are you looking for?" autocomplete="off" />
            <button id="send">Send</button>
        </form>
    </div>

    <script>
        const chat = document.getElementById("chat");
        const form = document.getElementById("form");
        const input = document.getElementById("input");
        const send = document.getElementById("send");

        let state = "INIT";

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (send.disabled) return;

            const msg = input.value.trim();
            if (!msg) return;

            addMessage(msg, "user");
            input.value = "";
            setLoading(true);

            try {
                if (state === "INIT") {
                    await startInterview(msg);
                } else {
                    await processAnswers(msg);
                }
            } catch (err) {
                console.error(err);
                addMessage("Something went wrong. Try again.", "bot");
                state = "INIT";
            } finally {
                setLoading(false);
            }
        });

        async function startInterview(query) {
            const res = await fetch("/mcp/gemini/interview/start", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ initialQuery: query }),
            });

            if (!res.ok) throw new Error("Backend error");

            const data = await res.json();

            let text = "I need a bit more info:\n\n";
            data.questions.forEach((q, i) => text += `${i + 1}. ${q}\n`);

            addMessage(text, "bot");
            state = "WAITING";
        }

        async function processAnswers(raw) {
            const answers = raw.split("\n").map(a => a.trim()).filter(Boolean);

            const res = await fetch("/mcp/gemini/interview/process", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ answers }),
            });

            if (!res.ok) throw new Error("Backend error");

            const data = await res.json();
            addMessage("Here are the best matches:", "bot");

            const items = [];
            data.results?.forEach(r => r.items && items.push(...r.items));

            if (items.length) addProducts(items);
            else addMessage("No products matched.", "bot");

            state = "INIT";
        }

        function addMessage(text, who) {
            const div = document.createElement("div");
            div.className = `message ${who}`;

            const avatar = document.createElement("div");
            avatar.className = "avatar";
            avatar.textContent = who === "bot" ? "ü§ñ" : "üë§";

            const bubble = document.createElement("div");
            bubble.className = "bubble";
            bubble.textContent = text;

            div.append(avatar, bubble);
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function addProducts(products) {
            const grid = document.createElement("div");
            grid.className = "products-grid";

            products.forEach(p => {
                const a = document.createElement("a");
                a.className = "product-card";
                a.href = p.url;
                a.target = "_blank";

                const img = document.createElement("img");
                img.className = "product-image";
                img.src = p.image || "https://via.placeholder.com/150";

                const t = document.createElement("div");
                t.className = "product-title";
                t.textContent = p.title;

                const pr = document.createElement("div");
                pr.className = "product-price";
                pr.textContent = p.price || "N/A";

                a.append(img, t, pr);
                grid.appendChild(a);
            });

            const wrap = document.createElement("div");
            wrap.className = "message bot";
            wrap.append(document.createElement("div"), grid);
            chat.appendChild(wrap);
        }

        function setLoading(v) {
            send.disabled = v;
            input.disabled = v;
        }
    </script>
</body>

</html>